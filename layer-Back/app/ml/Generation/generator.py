import requests
import os
import logging

logger = logging.getLogger(__name__)

OLLAMA_URL = os.getenv("OLLAMA_URL", "http://localhost:11434/api/chat")
OLLAMA_MODEL = os.getenv("OLLAMA_MODEL", "llama3")

# üß† –£—Å–∏–ª–µ–Ω–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–ª—è –º–æ–¥–µ–ª–∏ (—é—Ä–∏–¥–∏—á–µ—Å–∫–∞—è —Å—Ç—Ä–æ–≥–æ—Å—Ç—å)
SYSTEM_PROMPT = (
    "–¢—ã –≤—ã—Å—Ç—É–ø–∞–µ—à—å –≤ —Ä–æ–ª–∏ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–≥–æ —é—Ä–∏–¥–∏—á–µ—Å–∫–æ–≥–æ –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç–∞. "
    "–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –¥–∞–≤–∞—Ç—å —Ç–æ—á–Ω—ã–µ, –æ–¥–Ω–æ–∑–Ω–∞—á–Ω—ã–µ –∏ —Å—Ç—Ä–æ–≥–æ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã "
    "–∏—Å–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞.\n\n"
    "‚ö†Ô∏è –ó–∞–ø—Ä–µ—â–µ–Ω–æ:\n"
    "- –î–µ–ª–∞—Ç—å –ø—Ä–µ–¥–ø–æ–ª–æ–∂–µ–Ω–∏—è –∏–ª–∏ –¥–æ–≥–∞–¥–∫–∏\n"
    "- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∑–Ω–∞–Ω–∏—è –≤–Ω–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞\n"
    "- –ò–∑–ª–∞–≥–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –Ω–µ—Ñ–æ—Ä–º–∞–ª—å–Ω–æ –∏–ª–∏ –≤ —Ä–∞–∑–≥–æ–≤–æ—Ä–Ω–æ–π —Ñ–æ—Ä–º–µ\n\n"
    "‚úÖ –¢—Ä–µ–±—É–µ—Ç—Å—è:\n"
    "- –î–∞–≤–∞—Ç—å –∫—Ä–∞—Ç–∫–∏–π, —Å—Ç—Ä–æ–≥–∏–π –∏ —Ñ–æ—Ä–º–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç\n"
    "- –°—Å—ã–ª–∞—Ç—å—Å—è –Ω–∞ –ø—É–Ω–∫—Ç—ã, —Å—Ç–∞—Ç—å–∏, –¥–∞—Ç—ã, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ\n"
    "- –ï—Å–ª–∏ –æ—Ç–≤–µ—Ç–∞ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –Ω–µ—Ç ‚Äî –ø—Ä—è–º–æ —Å–æ–æ–±—â–∏—Ç—å: ¬´–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ.¬ª\n"
)

def generate_answer(prompt: str) -> str:
    """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º Ollama –∏ —Å—Ç—Ä–æ–≥–æ–π —é—Ä–∏–¥–∏—á–µ—Å–∫–æ–π –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–µ–π."""
    try:
        payload = {
            "model": OLLAMA_MODEL,
            "messages": [
                {"role": "system", "content": SYSTEM_PROMPT},
                {"role": "user", "content": prompt}
            ],
            "stream": False,
        }
        response = requests.post(OLLAMA_URL, json=payload)
        response.raise_for_status()

        data = response.json()
        if "message" in data and "content" in data["message"]:
            return data["message"]["content"].strip()
        else:
            logger.error(f"–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ –æ—Ç –º–æ–¥–µ–ª–∏: {data}")
            return "‚ö†Ô∏è –û—à–∏–±–∫–∞: –º–æ–¥–µ–ª—å –≤–µ—Ä–Ω—É–ª–∞ –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç."
    except Exception as e:
        logger.exception("–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–∞")
        return "‚ùå –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."
