import requests
import os
import logging

logger = logging.getLogger(__name__)

GENERATOR_URL = os.getenv("GENERATOR_URL")
GENERATOR_MODEL = os.getenv("GENERATOR_MODEL")

# üß† –£—Å–∏–ª–µ–Ω–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–ª—è –º–æ–¥–µ–ª–∏ (—é—Ä–∏–¥–∏—á–µ—Å–∫–∞—è —Å—Ç—Ä–æ–≥–æ—Å—Ç—å)
SYSTEM_PROMPT = """
–¢—ã ‚Äî —é—Ä–∏–¥–∏—á–µ—Å–∫–∏–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç, —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä—É—é—â–∏–π—Å—è –Ω–∞ —É–≥–æ–ª–æ–≤–Ω–æ–º –ø—Ä–∞–≤–µ –†–µ—Å–ø—É–±–ª–∏–∫–∏ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω.

–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî —Å–æ—Å—Ç–∞–≤–∏—Ç—å —Å—Ç—Ä–æ–≥–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–æ–µ–∫—Ç ¬´–ü–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –æ –∫–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏–∏ –¥–µ—è–Ω–∏—è¬ª –ø–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º –∞–Ω–∞–ª–∏–∑–∞ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ (–∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤: –¥–æ–ø—Ä–æ—Å–æ–≤, –∑–∞–∫–ª—é—á–µ–Ω–∏–π, –∑–∞—è–≤–ª–µ–Ω–∏–π, –ø—Ä–æ—Ç–æ–∫–æ–ª–æ–≤).

üìå –í–µ—Ä–Ω–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Å—Ç—Ä–æ–≥–æ –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON-–º–∞—Å—Å–∏–≤–∞ —Å –ø–æ–ª—è–º–∏:
[
  {
    "title": "–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–∞–∑–¥–µ–ª–∞",
    "paragraph": "–û—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ-–¥–µ–ª–æ–≤–æ–π —Ç–µ–∫—Å—Ç —ç—Ç–æ–≥–æ —Ä–∞–∑–¥–µ–ª–∞",
    "ai": true
  },
  ...
]

üîí –ò—Å–ø–æ–ª—å–∑—É–π —Ç–æ–ª—å–∫–æ —Ñ–∞–∫—Ç—ã –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞. –ù–∏–∫–∞–∫–∏—Ö –¥–æ–º—ã—Å–ª–æ–≤, –æ–±–æ–±—â–µ–Ω–∏–π –∏–ª–∏ –≥–∏–ø–æ—Ç–µ–∑.
üìö –ù–µ —É–∫–∞–∑—ã–≤–∞–π —Å—Ç–∞—Ç—å–∏ –£–ö –†–ö ‚Äî —Ç–æ–ª—å–∫–æ —Ç–∏–ø –ø—Ä–µ—Å—Ç—É–ø–ª–µ–Ω–∏—è.
üß† –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –ø—Ä–∏–∑–Ω–∞–∫–∏ —Å–æ—Å—Ç–∞–≤–∞ –ø—Ä–µ—Å—Ç—É–ø–ª–µ–Ω–∏—è: —Å—É–±—ä–µ–∫—Ç, –æ–±—ä–µ–∫—Ç, –≤–∏–Ω–∞, —Å–ø–æ—Å–æ–±, —É—â–µ—Ä–±.
‚úçÔ∏è –ü–∏—à–∏ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ-–¥–µ–ª–æ–≤—ã–º —è–∑—ã–∫–æ–º, –∫–∞–∫ —é—Ä–∏—Å—Ç –ú–í–î –∏–ª–∏ –ì–ö–ù–ë.

üßæ –†–∞–∑–¥–µ–ª—ã –ø–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è:
1. "–ó–∞–≥–æ–ª–æ–≤–æ–∫" ‚Äî –≤—Å–µ–≥–¥–∞: "–ü–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –æ –∫–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏–∏ –¥–µ—è–Ω–∏—è"
2. "–í–≤–æ–¥–Ω–∞—è —á–∞—Å—Ç—å" ‚Äî –∫–µ–º, –∫–æ–≥–¥–∞, –≥–¥–µ, —á—Ç–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ
3. "–§–∞–∫—Ç–∏—á–µ—Å–∫–∞—è —á–∞—Å—Ç—å" ‚Äî –∫–ª—é—á–µ–≤—ã–µ –æ–±—Å—Ç–æ—è—Ç–µ–ª—å—Å—Ç–≤–∞ –∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
4. "–Æ—Ä–∏–¥–∏—á–µ—Å–∫–∞—è –æ—Ü–µ–Ω–∫–∞" ‚Äî –ª–æ–≥–∏–∫–∞ –∫–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏–∏, –ø—Ä–∏–∑–Ω–∞–∫–∏ —Å–æ—Å—Ç–∞–≤–∞
5. "–†–µ–∑–æ–ª—é—Ç–∏–≤–Ω–∞—è —á–∞—Å—Ç—å" ‚Äî –≤—ã–≤–æ–¥, –¥–∞–ª—å–Ω–µ–π—à–∏–µ –¥–µ–π—Å—Ç–≤–∏—è
6. "–ü—Ä–∞–≤–∞ –ª–∏—Ü–∞" (–µ—Å–ª–∏ –µ—Å—Ç—å –ø–æ–¥–æ–∑—Ä–µ–≤–∞–µ–º—ã–π) ‚Äî –∫—Ä–∞—Ç–∫–æ–µ —Ä–∞–∑—ä—è—Å–Ω–µ–Ω–∏–µ
7. "–ü–æ–¥–ø–∏—Å—å –∏ –¥–∞—Ç–∞" ‚Äî –æ—Å—Ç–∞–≤–∏—Ç—å –ø—É—Å—Ç—ã–º, –º–æ–¥–µ–ª—å –Ω–µ –ø—Ä–∏–¥—É–º—ã–≤–∞–µ—Ç –∏–º—ë–Ω

–ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ ‚Äî –≤–∫–ª—é—á–∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –±–ª–æ–∫ —Å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–µ–π: –∫–∞–∫–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø—Ä–∏–ª–æ–∂–∏—Ç—å –¥–ª—è –∫–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏–∏.
""".strip()


def generate_answer(prompt: str) -> str:
    """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º Ollama –∏ —Å—Ç—Ä–æ–≥–æ–π —é—Ä–∏–¥–∏—á–µ—Å–∫–æ–π –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–µ–π."""
    try:
        payload = {
            "model": GENERATOR_MODEL,
            "messages": [
                {"role": "system", "content": SYSTEM_PROMPT},
                {"role": "user", "content": prompt}
            ],
            "stream": False,
        }
        response = requests.post(GENERATOR_URL, json=payload)
        response.raise_for_status()

        data = response.json()
        if "message" in data and "content" in data["message"]:
            return data["message"]["content"].strip()
        else:
            logger.error(f"–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ –æ—Ç –º–æ–¥–µ–ª–∏: {data}")
            return "‚ö†Ô∏è –û—à–∏–±–∫–∞: –º–æ–¥–µ–ª—å –≤–µ—Ä–Ω—É–ª–∞ –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç."
    except Exception as e:
        logger.exception("–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–∞")
        return "‚ùå –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."
